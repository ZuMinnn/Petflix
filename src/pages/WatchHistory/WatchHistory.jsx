import React, { useEffect, useState, useCallback } from 'react'
import { useNavigate } from 'react-router-dom'
import './WatchHistory.css'
import Navbar from '../../components/Navbar/Navbar'
import Footer from '../../components/Footer/Footer'
import MovieDetailsPanel from '../../components/MovieDetailsPanel/MovieDetailsPanel'
import { fetchMovieDetailBySlug } from '../../services/phimapi'
import { auth, getUserWatchHistory, subscribeToWatchHistory, deleteFromWatchHistory, clearAllWatchHistory, saveWatchProgress } from '../../firebase'
import { useAuthState } from 'react-firebase-hooks/auth'

// Global cache ƒë·ªÉ tr√°nh g·ªçi API tr√πng l·∫∑p
const posterCache = new Map()
const loadingQueue = new Set()

// Rate limiter ƒë·ªÉ tr√°nh spam API
let lastApiCall = 0
const API_DELAY = 1000 // 1 gi√¢y gi·ªØa m·ªói API call

// Cache key cho localStorage
const CACHE_KEY = 'moviePosterCache'
const CACHE_EXPIRY = 7 * 24 * 60 * 60 * 1000 // 7 ng√†y

// Load cache t·ª´ localStorage
const loadCacheFromStorage = () => {
  try {
    const cached = localStorage.getItem(CACHE_KEY)
    if (cached) {
      const parsed = JSON.parse(cached)
      const now = Date.now()
      
      // Filter out expired entries
      const validEntries = Object.entries(parsed).filter(([, value]) => {
        return value.timestamp && (now - value.timestamp) < CACHE_EXPIRY
      })
      
      // Convert back to Map
      validEntries.forEach(([key, value]) => {
        posterCache.set(key, value.url)
      })
      
      // Update localStorage with only valid entries
      if (validEntries.length !== Object.keys(parsed).length) {
        const validCache = Object.fromEntries(
          validEntries.map(([key, value]) => [key, value])
        )
        localStorage.setItem(CACHE_KEY, JSON.stringify(validCache))
      }
    }
  } catch (error) {
    console.error('Error loading poster cache:', error)
  }
}

// Save cache to localStorage
const saveCacheToStorage = (movieSlug, posterUrl) => {
  try {
    const cached = localStorage.getItem(CACHE_KEY)
    const cache = cached ? JSON.parse(cached) : {}
    
    cache[movieSlug] = {
      url: posterUrl,
      timestamp: Date.now()
    }
    
    localStorage.setItem(CACHE_KEY, JSON.stringify(cache))
  } catch (error) {
    console.error('Error saving poster cache:', error)
  }
}

// Initialize cache from localStorage
loadCacheFromStorage()

// Clear old cache entries
const clearOldCache = () => {
  try {
    const cached = localStorage.getItem(CACHE_KEY)
    if (cached) {
      const parsed = JSON.parse(cached)
      const now = Date.now()
      
      // Keep only entries newer than 7 days
      const validEntries = Object.entries(parsed).filter(([, value]) => {
        return value.timestamp && (now - value.timestamp) < CACHE_EXPIRY
      })
      
      const validCache = Object.fromEntries(validEntries)
      localStorage.setItem(CACHE_KEY, JSON.stringify(validCache))
      
      // Update in-memory cache
      posterCache.clear()
      validEntries.forEach(([key, value]) => {
        posterCache.set(key, value.url)
      })
      
      return validEntries.length
    }
  } catch (error) {
    console.error('Error clearing old cache:', error)
  }
  return 0
}

const MoviePoster = ({ movieSlug, title, index = 0 }) => {
  const [posterUrl, setPosterUrl] = useState(null)
  const [imageError, setImageError] = useState(false)
  const [loading, setLoading] = useState(false)

  useEffect(() => {
    const loadPosterWithDelay = async () => {
      if (!movieSlug || posterCache.has(movieSlug) || loadingQueue.has(movieSlug)) {
        // N·∫øu ƒë√£ c√≥ cache ho·∫∑c ƒëang loading, s·ª≠ d·ª•ng cache
        const cached = posterCache.get(movieSlug)
        if (cached) {
          setPosterUrl(cached)
        }
        return
      }

      // Th√™m delay d·ª±a tr√™n index ƒë·ªÉ tr√°nh g·ªçi API c√πng l√∫c
      const delay = index * 800 + Math.random() * 500 // Stagger loading
      
      setTimeout(async () => {
        if (loadingQueue.has(movieSlug)) return
        
        loadingQueue.add(movieSlug)
        setLoading(true)

        try {
          // Rate limiting
          const now = Date.now()
          const timeSinceLastCall = now - lastApiCall
          if (timeSinceLastCall < API_DELAY) {
            await new Promise(resolve => setTimeout(resolve, API_DELAY - timeSinceLastCall))
          }
          lastApiCall = Date.now()

          const detail = await fetchMovieDetailBySlug(movieSlug)
          let url = null
          
          if (detail?.movie?.poster_url) {
            url = detail.movie.poster_url
          } else if (detail?.movie?.thumb_url) {
            url = detail.movie.thumb_url
          }

          if (url) {
            posterCache.set(movieSlug, url)
            saveCacheToStorage(movieSlug, url)
            setPosterUrl(url)
          } else {
            posterCache.set(movieSlug, 'error')
            setImageError(true)
          }
        } catch (error) {
          console.error(`Error loading poster for ${movieSlug}:`, error)
          posterCache.set(movieSlug, 'error')
          setImageError(true)
        } finally {
          setLoading(false)
          loadingQueue.delete(movieSlug)
        }
      }, delay)
    }

    loadPosterWithDelay()
  }, [movieSlug, index])

  const handleImageError = () => {
    setImageError(true)
    posterCache.set(movieSlug, 'error')
  }

  if (loading) {
    return (
      <div className='history-poster'>
        <div className='history-placeholder loading-placeholder'>
          ‚è≥
        </div>
      </div>
    )
  }

  if (!posterUrl || imageError || posterCache.get(movieSlug) === 'error') {
    return (
      <div className='history-poster'>
        <div className='history-placeholder'>
          üì∫
        </div>
      </div>
    )
  }

  return (
    <div className='history-poster'>
      <img 
        src={posterUrl} 
        alt={title || 'Movie poster'} 
        className='history-poster-image'
        onError={handleImageError}
        loading="lazy"
      />
    </div>
  )
}

const WatchHistory = () => {
  const navigate = useNavigate()
  const [user] = useAuthState(auth)
  const [watchHistory, setWatchHistory] = useState([])
  const [loading, setLoading] = useState(true)
  const [selectedMovie, setSelectedMovie] = useState(null)
  const [movieDetail, setMovieDetail] = useState(null)
  const [showDetails, setShowDetails] = useState(false)

  const loadWatchHistory = useCallback(async () => {
    try {
      setLoading(true)
      
      if (!user) {
        setWatchHistory([])
        return
      }
      
      const history = await getUserWatchHistory(user.uid)
      
      setWatchHistory(history)
    } catch (error) {
      console.error('‚ùå Error loading watch history:', error)
    } finally {
      setLoading(false)
    }
  }, [user])

  // Load watch history and setup real-time subscription
  useEffect(() => {
    if (!user) {
      navigate('/login')
      return
    }

    // Clean up old cache entries on mount
    clearOldCache()

    loadWatchHistory()

    // Setup real-time subscription
    const unsubscribe = subscribeToWatchHistory(user.uid, (history) => {
      setWatchHistory(history)
    })

    return () => {
      unsubscribe()
    }
  }, [user, navigate, loadWatchHistory])

  // Clear all watch history
  const clearHistory = async () => {
    if (window.confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ xem phim?')) {
      try {
        if (!user) return
        
        await clearAllWatchHistory(user.uid)
        setWatchHistory([])
        
      } catch (error) {
        console.error('‚ùå Error clearing history:', error)
      }
    }
  }

  // Remove single movie from history
  const removeFromHistory = async (movieSlug) => {
    try {
      if (!user) return
      
      await deleteFromWatchHistory(user.uid, movieSlug)
      
      // Update state
      setWatchHistory(prev => prev.filter(item => item.movieSlug !== movieSlug))
      
    } catch (error) {
      console.error('‚ùå Error removing from history:', error)
    }
  }

  // Continue watching
  const continueWatching = (historyItem) => {
    const state = {
      title: historyItem.title,
      movieSlug: historyItem.movieSlug,
      episodeSlug: historyItem.episodeSlug,
      returnPath: '/watch-history'
    }
    
    navigate('/watch', { state })
  }

  // View movie details
  const viewMovieDetails = async (historyItem) => {
    setSelectedMovie({
      slug: historyItem.movieSlug,
      name: historyItem.title
    })
    setMovieDetail(null)
    setShowDetails(true)
    
    try {
      const detail = await fetchMovieDetailBySlug(historyItem.movieSlug)
      setMovieDetail(detail)
    } catch (error) {
      console.error('Error fetching movie details:', error)
    }
  }

  // Format watch time
  const formatWatchTime = (updatedAt) => {
    if (!updatedAt) return 'Kh√¥ng r√µ'
    
    const now = Date.now()
    const diff = now - updatedAt
    const days = Math.floor(diff / (1000 * 60 * 60 * 24))
    const hours = Math.floor(diff / (1000 * 60 * 60))
    const minutes = Math.floor(diff / (1000 * 60))
    
    if (days > 0) return `${days} ng√†y tr∆∞·ªõc`
    if (hours > 0) return `${hours} gi·ªù tr∆∞·ªõc`
    if (minutes > 0) return `${minutes} ph√∫t tr∆∞·ªõc`
    return 'V·ª´a xem'
  }

  // Format progress
  const formatProgress = (currentTime, duration) => {
    if (!duration || duration <= 0) return '0%'
    const percent = Math.round((currentTime / duration) * 100)
    return `${Math.min(100, Math.max(0, percent))}%`
  }

  // Debug Firebase + localStorage
  const debugLocalStorage = async () => {
    // Debug localStorage (old system)
    const progressKeys = []
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i)
      if (key && key.startsWith('watchProgress:')) {
        progressKeys.push(key)
      }
    }
    
    // Debug poster cache
    const posterCacheData = localStorage.getItem(CACHE_KEY)
    const posterCacheCount = posterCacheData ? Object.keys(JSON.parse(posterCacheData)).length : 0
    
    // Debug Firebase (new system)
    if (user) {
      try {
        const firebaseHistory = await getUserWatchHistory(user.uid)
        
        alert(`
LocalStorage (old): ${progressKeys.length} entries
Firebase (new): ${firebaseHistory.length} entries
Poster Cache: ${posterCacheCount} entries
Xem console ƒë·ªÉ bi·∫øt chi ti·∫øt.`)
      } catch (e) {
        console.error('Error loading Firebase history:', e)
        alert(`
LocalStorage (old): ${progressKeys.length} entries
Firebase (new): Error loading
Poster Cache: ${posterCacheCount} entries
Xem console ƒë·ªÉ bi·∫øt chi ti·∫øt.`)
      }
    } else {
      alert(`Ch∆∞a ƒëƒÉng nh·∫≠p! 
LocalStorage (old): ${progressKeys.length} entries
Poster Cache: ${posterCacheCount} entries`)
    }
  }

  // Clear poster cache
  const clearPosterCache = () => {
    if (window.confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a cache h√¨nh ·∫£nh poster? ƒêi·ªÅu n√†y s·∫Ω l√†m ch·∫≠m l·∫ßn t·∫£i ti·∫øp theo.')) {
      try {
        localStorage.removeItem(CACHE_KEY)
        posterCache.clear()
        alert('‚úÖ ƒê√£ x√≥a cache poster th√†nh c√¥ng!')
      } catch (error) {
        console.error('Error clearing poster cache:', error)
        alert('‚ùå L·ªói khi x√≥a cache poster!')
      }
    }
  }

  // Create test data
  const createTestData = async () => {
    if (!user) {
      alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!')
      return
    }

    const testEntries = [
      {
        movieSlug: 'john-wick-4',
        episodeSlug: 'tap-1',
        data: {
          currentTime: 1800, // 30 minutes
          duration: 3600, // 1 hour
          title: 'John Wick 4 - T·∫≠p 1'
        }
      },
      {
        movieSlug: 'avengers-endgame',
        episodeSlug: 'full-movie',
        data: {
          currentTime: 5400, // 1.5 hours
          duration: 10800, // 3 hours
          title: 'Avengers Endgame - Full Movie'
        }
      },
      {
        movieSlug: 'spider-man-homecoming',
        episodeSlug: 'episode-5',
        data: {
          currentTime: 900, // 15 minutes
          duration: 2400, // 40 minutes
          title: 'Spider-Man Homecoming - Episode 5'
        }
      }
    ]

    try {
      for (const entry of testEntries) {
        await saveWatchProgress(user.uid, entry.movieSlug, entry.episodeSlug, entry.data)
      }
      
      alert('üî• ƒê√£ t·∫°o test data l√™n Firebase! Click "L√†m m·ªõi" ƒë·ªÉ xem.')
      loadWatchHistory()
    } catch (error) {
      console.error('‚ùå Error creating test data:', error)
      alert('L·ªói t·∫°o test data!')
    }
  }

  // Manual test to save current movie being viewed
  const manualSaveProgress = async () => {
    if (!user) {
      alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!')
      return
    }

    const movieSlug = `test-movie-${Date.now()}`
    const episodeSlug = 'episode-1'
    const testData = {
      currentTime: 300, // 5 minutes
      duration: 1800, // 30 minutes
      title: `Test Movie - ${new Date().toLocaleTimeString()}`
    }
    
    try {
      await saveWatchProgress(user.uid, movieSlug, episodeSlug, testData)
      alert('üî• ƒê√£ l∆∞u test progress l√™n Firebase! Click "L√†m m·ªõi" ƒë·ªÉ xem.')
      loadWatchHistory()
    } catch (error) {
      console.error('‚ùå Error saving manual progress:', error)
      alert('L·ªói l∆∞u test progress!')
    }
  }

  if (!user) {
    return null // Will redirect to login
  }

  return (
    <div className='watch-history-page'>
      <Navbar />
      
      <div className='watch-history-container'>
        {/* Header */}
        <div className='history-header'>
          <button onClick={() => navigate('/')} className='back-btn'>
            ‚Üê Trang ch·ªß
          </button>
          <h1>Phim ƒë√£ xem</h1>
          <div className='history-actions'>
            <button onClick={loadWatchHistory} className='refresh-btn'>
               L√†m m·ªõi
            </button>
            <button onClick={debugLocalStorage} className='debug-btn'>
              üêõ Debug
            </button>
            <button onClick={clearPosterCache} className='clear-cache-btn'>
              üóëÔ∏è Clear Cache
            </button>
            <button onClick={createTestData} className='test-btn'>
              üß™ Test Data
            </button>
            <button onClick={manualSaveProgress} className='manual-btn'>
              üíæ Manual Save
            </button>
            {watchHistory.length > 0 && (
              <button onClick={clearHistory} className='clear-btn'>
                 X√≥a t·∫•t c·∫£
              </button>
            )}
          </div>
        </div>

        {/* Loading State */}
        {loading ? (
          <div className='history-loading'>
            <div className='loading-spinner'></div>
            <p>ƒêang t·∫£i l·ªãch s·ª≠ xem phim...</p>
          </div>
        ) : (
          <>
            {/* History Grid */}
            {watchHistory.length > 0 ? (
              <div className='history-grid'>
                                 {watchHistory.map((item, index) => (
                   <div key={item.id || item.movieSlug || index} className='history-card'>
                    <div className='history-poster-container'>
                      <MoviePoster 
                        movieSlug={item.movieSlug} 
                        title={item.title}
                        index={index}
                      />
                      <div className='history-progress-bar'>
                        <div 
                          className='history-progress-fill'
                          style={{ width: formatProgress(item.currentTime, item.duration) }}
                        ></div>
                      </div>
                      <div className='history-overlay'>
                        <button 
                          className='continue-btn'
                          onClick={() => continueWatching(item)}
                        >
                          ‚ñ∂ Ti·∫øp t·ª•c
                        </button>
                        <button 
                          className='details-btn'
                          onClick={() => viewMovieDetails(item)}
                        >
                           Chi ti·∫øt
                        </button>
                      </div>
                    </div>
                    <div className='history-info'>
                      <h3 className='history-title'>{item.title || 'Kh√¥ng r√µ t√™n'}</h3>
                      <p className='history-episode'>
                        T·∫≠ nep: {item.episodeSlug || 'N/A'}
                      </p>
                      <p className='history-progress'>
                        ƒê√£ xem
                      </p>
                      <p className='history-time'>
                        {formatWatchTime(item.updatedAt)}
                      </p>
                      <button 
                        className='remove-btn'
                        onClick={() => removeFromHistory(item.movieSlug)}
                      >
                        ‚úï X√≥a
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className='history-empty'>
                <div className='empty-icon'>üì∫</div>
                <h2>Ch∆∞a c√≥ phim n√†o trong l·ªãch s·ª≠</h2>
                <p>B·∫Øt ƒë·∫ßu xem phim ƒë·ªÉ theo d√µi ti·∫øn ƒë·ªô c·ªßa b·∫°n</p>
                
                <div className='debug-info'>
                  <h3>üîß Debug Steps:</h3>
                  <ol>
                    <li>Click <strong>"üêõ Debug"</strong> ƒë·ªÉ ki·ªÉm tra localStorage</li>
                    <li>Click <strong>"üß™ Test Data"</strong> ƒë·ªÉ t·∫°o d·ªØ li·ªáu m·∫´u</li>
                    <li>Ho·∫∑c ƒëi xem phim th·∫≠t v√† quay l·∫°i</li>
                  </ol>
                  <p><strong>L∆∞u √Ω:</strong> Ch·ªâ phim c√≥ movieSlug v√† episodeSlug m·ªõi ƒë∆∞·ª£c track</p>
                </div>
                
                <div className='action-buttons'>
                  <button 
                    onClick={() => navigate('/simple-movies?page=1')} 
                    className='browse-btn'
                  >
                    Kh√°m ph√° phim
                  </button>
                  <button 
                    onClick={createTestData} 
                    className='test-data-btn'
                  >
                    üß™ T·∫°o d·ªØ li·ªáu test
                  </button>
                </div>
              </div>
            )}
          </>
        )}
      </div>
      
      <Footer />
      
      {/* Movie Details Panel */}
      <MovieDetailsPanel 
        open={showDetails} 
        onClose={() => setShowDetails(false)} 
        movie={selectedMovie} 
        detail={movieDetail} 
      />
    </div>
  )
}

export default WatchHistory
